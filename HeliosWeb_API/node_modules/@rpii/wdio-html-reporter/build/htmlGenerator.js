"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

require("source-map-support/register");

const Handlebars = require('handlebars');

const fs = require('fs-extra');

const _ = require('lodash');

const path = require('path');

const moment = require('moment');

const base64Img = require('base64-img');

const logger = require('@log4js-node/log4js-api');

const momentDurationFormatSetup = require("moment-duration-format");

momentDurationFormatSetup(moment);

class HtmlGenerator {
  static htmlOutput(reportOptions, callback = () => {}) {
    try {
      if (reportOptions.LOG) {
        reportOptions.LOG.debug("Html Generation started");
      }

      let templateFile = fs.readFileSync(reportOptions.templateFilename, 'utf8');
      Handlebars.registerHelper('imageAsBase64', function (screenshotFile, screenshotPath, hbopts) {
        // occurs when there is an error file
        if (!fs.existsSync(screenshotFile)) {
          if (screenshotPath) {
            screenshotFile = `${screenshotPath}/${screenshotFile}`;
          } else {
            screenshotFile = `${screenshotFile}`;
          }
        }

        const data = base64Img.base64Sync(path.resolve(`${screenshotFile}`));
        return `${data}`;
      });
      Handlebars.registerHelper('isValidReport', function (suites, hbopts) {
        if (suites && suites.length > 0) {
          return hbopts.fn(this);
        }

        return hbopts.inverse(this);
      });
      Handlebars.registerHelper('isValidSuite', function (suite, hbopts) {
        if (suite.title.length > 0 && suite.type === 'suite' && suite.tests.length > 0) {
          return hbopts.fn(this);
        }

        return hbopts.inverse(this);
      });
      Handlebars.registerHelper('testStateColour', function (state, hbopts) {
        if (state === 'passed') {
          return 'test-pass';
        } else if (state === 'failed') {
          return 'test-fail';
        } else if (state === 'pending') {
          return 'test-pending';
        } else if (state === 'skipped') {
          return 'test-skipped';
        }
      });
      Handlebars.registerHelper('testStateIcon', function (state, hbopts) {
        if (state === 'passed') {
          return '<span class="success">&#10004;</span>';
        } else if (state === 'failed') {
          return '<span class="error">&#10006;</span>';
        } else if (state === 'pending') {
          return '<span class="pending">&#10004;</span>';
        } else if (state === 'skipped') {
          return '<span class="skipped">&#10034;</span>';
        }
      });
      Handlebars.registerHelper('suiteStateColour', function (tests, hbopts) {
        let numTests = Object.keys(tests).length;

        _.values(tests).find(test => {
          if (test.state === "pending") {
            --numTests;
          }
        });

        let fail = _.values(tests).find(test => {
          return test.state === 'failed';
        });

        if (fail != null) {
          return 'suite-fail';
        }

        let passes = _.values(tests).filter(test => {
          return test.state === 'passed';
        });

        if (passes.length === numTests && numTests > 0) {
          return 'suite-pass';
        } //skipped is the lowest priority check


        let skipped = _.values(tests).find(test => {
          return test.state === 'skipped';
        });

        if (skipped != null) {
          return 'suite-pending';
        }

        return 'suite-unknown';
      });
      Handlebars.registerHelper('humanizeDuration', function (duration, hbopts) {
        return moment.duration(duration, "milliseconds").format('hh:mm:ss.SS', {
          trim: false
        });
      });
      Handlebars.registerHelper('ifSuiteHasTests', function (testsHash, hbopts) {
        if (Object.keys(testsHash).length > 0) {
          return hbopts.fn(this);
        }

        return hbopts.inverse(this);
      });
      Handlebars.registerHelper('ifEventIsError', function (event, hbopts) {
        if (event.type.includes('Error')) {
          return hbopts.fn(this);
        }

        return hbopts.inverse(this);
      });
      Handlebars.registerHelper('ifEventIsScreenshot', function (event, hbopts) {
        if (event.type === 'screenshot') {
          return hbopts.fn(this);
        }

        return hbopts.inverse(this);
      });
      Handlebars.registerHelper('ifEventIsLogMessage', function (event, hbopts) {
        if (event.type === 'log') {
          return hbopts.fn(this);
        }

        return hbopts.inverse(this);
      });
      Handlebars.registerHelper('ifCollapseTests', function (text, hbopts) {
        return reportOptions.collapseTests;
      });
      Handlebars.registerHelper('logClass', function (text, hbopts) {
        if (text.includes('Test Iteration')) {
          return "test-iteration";
        } else {
          return "log-output";
        }
      });
      Object.keys(reportOptions.templateFuncs).forEach(key => {
        Handlebars.registerHelper(key, reportOptions.templateFuncs[key]);
      });

      if (fs.pathExistsSync(reportOptions.outputDir)) {
        let jsonFile = reportOptions.reportFile.replace('.html', '.json');
        fs.outputFileSync(jsonFile, JSON.stringify(reportOptions.data));
      }

      let template = Handlebars.compile(templateFile);
      let html = template(reportOptions.data);

      if (fs.pathExistsSync(reportOptions.outputDir)) {
        fs.outputFileSync(reportOptions.reportFile, html);
      }

      if (reportOptions.LOG) {
        reportOptions.LOG.debug("Html Generation completed");
      }

      callback(true);
    } catch (ex) {
      if (reportOptions.LOG) {
        reportOptions.LOG.error("Html Generation processing ended in error: " + ex);
      }

      callback(false);
    }
  }

}

var _default = HtmlGenerator;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9odG1sR2VuZXJhdG9yLmpzIl0sIm5hbWVzIjpbIkhhbmRsZWJhcnMiLCJyZXF1aXJlIiwiZnMiLCJfIiwicGF0aCIsIm1vbWVudCIsImJhc2U2NEltZyIsImxvZ2dlciIsIm1vbWVudER1cmF0aW9uRm9ybWF0U2V0dXAiLCJIdG1sR2VuZXJhdG9yIiwiaHRtbE91dHB1dCIsInJlcG9ydE9wdGlvbnMiLCJjYWxsYmFjayIsIkxPRyIsImRlYnVnIiwidGVtcGxhdGVGaWxlIiwicmVhZEZpbGVTeW5jIiwidGVtcGxhdGVGaWxlbmFtZSIsInJlZ2lzdGVySGVscGVyIiwic2NyZWVuc2hvdEZpbGUiLCJzY3JlZW5zaG90UGF0aCIsImhib3B0cyIsImV4aXN0c1N5bmMiLCJkYXRhIiwiYmFzZTY0U3luYyIsInJlc29sdmUiLCJzdWl0ZXMiLCJsZW5ndGgiLCJmbiIsImludmVyc2UiLCJzdWl0ZSIsInRpdGxlIiwidHlwZSIsInRlc3RzIiwic3RhdGUiLCJudW1UZXN0cyIsIk9iamVjdCIsImtleXMiLCJ2YWx1ZXMiLCJmaW5kIiwidGVzdCIsImZhaWwiLCJwYXNzZXMiLCJmaWx0ZXIiLCJza2lwcGVkIiwiZHVyYXRpb24iLCJmb3JtYXQiLCJ0cmltIiwidGVzdHNIYXNoIiwiZXZlbnQiLCJpbmNsdWRlcyIsInRleHQiLCJjb2xsYXBzZVRlc3RzIiwidGVtcGxhdGVGdW5jcyIsImZvckVhY2giLCJrZXkiLCJwYXRoRXhpc3RzU3luYyIsIm91dHB1dERpciIsImpzb25GaWxlIiwicmVwb3J0RmlsZSIsInJlcGxhY2UiLCJvdXRwdXRGaWxlU3luYyIsIkpTT04iLCJzdHJpbmdpZnkiLCJ0ZW1wbGF0ZSIsImNvbXBpbGUiLCJodG1sIiwiZXgiLCJlcnJvciJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7O0FBQ0EsTUFBTUEsVUFBVSxHQUFHQyxPQUFPLENBQUMsWUFBRCxDQUExQjs7QUFDQSxNQUFNQyxFQUFFLEdBQUdELE9BQU8sQ0FBQyxVQUFELENBQWxCOztBQUNBLE1BQU1FLENBQUMsR0FBR0YsT0FBTyxDQUFDLFFBQUQsQ0FBakI7O0FBQ0EsTUFBTUcsSUFBSSxHQUFHSCxPQUFPLENBQUMsTUFBRCxDQUFwQjs7QUFDQSxNQUFNSSxNQUFNLEdBQUdKLE9BQU8sQ0FBQyxRQUFELENBQXRCOztBQUNBLE1BQU1LLFNBQVMsR0FBR0wsT0FBTyxDQUFDLFlBQUQsQ0FBekI7O0FBQ0EsTUFBTU0sTUFBTSxHQUFHTixPQUFPLENBQUMseUJBQUQsQ0FBdEI7O0FBRUEsTUFBTU8seUJBQXlCLEdBQUdQLE9BQU8sQ0FBQyx3QkFBRCxDQUF6Qzs7QUFDQU8seUJBQXlCLENBQUNILE1BQUQsQ0FBekI7O0FBRUEsTUFBTUksYUFBTixDQUFxQjtBQUVqQixTQUFPQyxVQUFQLENBQWtCQyxhQUFsQixFQUFpQ0MsUUFBUSxHQUFHLE1BQUssQ0FBRSxDQUFuRCxFQUFxRDtBQUNqRCxRQUFJO0FBQ0EsVUFBSUQsYUFBYSxDQUFDRSxHQUFsQixFQUF1QjtBQUNuQkYsUUFBQUEsYUFBYSxDQUFDRSxHQUFkLENBQWtCQyxLQUFsQixDQUF3Qix5QkFBeEI7QUFDSDs7QUFDRCxVQUFJQyxZQUFZLEdBQUdiLEVBQUUsQ0FBQ2MsWUFBSCxDQUFnQkwsYUFBYSxDQUFDTSxnQkFBOUIsRUFBZ0QsTUFBaEQsQ0FBbkI7QUFFQWpCLE1BQUFBLFVBQVUsQ0FBQ2tCLGNBQVgsQ0FBMEIsZUFBMUIsRUFBMkMsVUFBVUMsY0FBVixFQUEwQkMsY0FBMUIsRUFBMENDLE1BQTFDLEVBQWtEO0FBQ3pGO0FBQ0EsWUFBSSxDQUFDbkIsRUFBRSxDQUFDb0IsVUFBSCxDQUFjSCxjQUFkLENBQUwsRUFBb0M7QUFDaEMsY0FBSUMsY0FBSixFQUFvQjtBQUNoQkQsWUFBQUEsY0FBYyxHQUFJLEdBQUVDLGNBQWUsSUFBR0QsY0FBZSxFQUFyRDtBQUNILFdBRkQsTUFFTztBQUNIQSxZQUFBQSxjQUFjLEdBQUksR0FBRUEsY0FBZSxFQUFuQztBQUNIO0FBQ0o7O0FBQ0QsY0FBTUksSUFBSSxHQUFHakIsU0FBUyxDQUFDa0IsVUFBVixDQUFxQnBCLElBQUksQ0FBQ3FCLE9BQUwsQ0FBYyxHQUFFTixjQUFlLEVBQS9CLENBQXJCLENBQWI7QUFDQSxlQUFRLEdBQUVJLElBQUssRUFBZjtBQUNILE9BWEQ7QUFZQXZCLE1BQUFBLFVBQVUsQ0FBQ2tCLGNBQVgsQ0FBMEIsZUFBMUIsRUFBMkMsVUFBVVEsTUFBVixFQUFrQkwsTUFBbEIsRUFBMEI7QUFDakUsWUFBSUssTUFBTSxJQUFJQSxNQUFNLENBQUNDLE1BQVAsR0FBZ0IsQ0FBOUIsRUFBa0M7QUFDOUIsaUJBQU9OLE1BQU0sQ0FBQ08sRUFBUCxDQUFVLElBQVYsQ0FBUDtBQUNIOztBQUNELGVBQU9QLE1BQU0sQ0FBQ1EsT0FBUCxDQUFlLElBQWYsQ0FBUDtBQUNILE9BTEQ7QUFNQTdCLE1BQUFBLFVBQVUsQ0FBQ2tCLGNBQVgsQ0FBMEIsY0FBMUIsRUFBMEMsVUFBVVksS0FBVixFQUFpQlQsTUFBakIsRUFBeUI7QUFDL0QsWUFBSVMsS0FBSyxDQUFDQyxLQUFOLENBQVlKLE1BQVosR0FBcUIsQ0FBckIsSUFDQUcsS0FBSyxDQUFDRSxJQUFOLEtBQWUsT0FEZixJQUVBRixLQUFLLENBQUNHLEtBQU4sQ0FBWU4sTUFBWixHQUFxQixDQUZ6QixFQUU2QjtBQUN6QixpQkFBT04sTUFBTSxDQUFDTyxFQUFQLENBQVUsSUFBVixDQUFQO0FBQ0g7O0FBQ0QsZUFBT1AsTUFBTSxDQUFDUSxPQUFQLENBQWUsSUFBZixDQUFQO0FBQ0gsT0FQRDtBQVNBN0IsTUFBQUEsVUFBVSxDQUFDa0IsY0FBWCxDQUEwQixpQkFBMUIsRUFBNkMsVUFBVWdCLEtBQVYsRUFBaUJiLE1BQWpCLEVBQXlCO0FBQ2xFLFlBQUlhLEtBQUssS0FBSyxRQUFkLEVBQXdCO0FBQ3BCLGlCQUFPLFdBQVA7QUFDSCxTQUZELE1BRU8sSUFBSUEsS0FBSyxLQUFLLFFBQWQsRUFBd0I7QUFDM0IsaUJBQU8sV0FBUDtBQUNILFNBRk0sTUFFQSxJQUFJQSxLQUFLLEtBQUssU0FBZCxFQUF5QjtBQUM1QixpQkFBTyxjQUFQO0FBQ0gsU0FGTSxNQUVBLElBQUlBLEtBQUssS0FBSyxTQUFkLEVBQXlCO0FBQ2hDLGlCQUFPLGNBQVA7QUFDSDtBQUNBLE9BVkQ7QUFZQWxDLE1BQUFBLFVBQVUsQ0FBQ2tCLGNBQVgsQ0FBMEIsZUFBMUIsRUFBMkMsVUFBVWdCLEtBQVYsRUFBaUJiLE1BQWpCLEVBQXlCO0FBQ2hFLFlBQUlhLEtBQUssS0FBSyxRQUFkLEVBQXdCO0FBQ3BCLGlCQUFPLHVDQUFQO0FBQ0gsU0FGRCxNQUVPLElBQUlBLEtBQUssS0FBSyxRQUFkLEVBQXdCO0FBQzNCLGlCQUFPLHFDQUFQO0FBQ0gsU0FGTSxNQUVBLElBQUlBLEtBQUssS0FBSyxTQUFkLEVBQXlCO0FBQzVCLGlCQUFPLHVDQUFQO0FBQ0gsU0FGTSxNQUVBLElBQUlBLEtBQUssS0FBSyxTQUFkLEVBQXlCO0FBQzVCLGlCQUFPLHVDQUFQO0FBQ0g7QUFDSixPQVZEO0FBWUFsQyxNQUFBQSxVQUFVLENBQUNrQixjQUFYLENBQTBCLGtCQUExQixFQUE4QyxVQUFVZSxLQUFWLEVBQWlCWixNQUFqQixFQUF5QjtBQUNuRSxZQUFJYyxRQUFRLEdBQUdDLE1BQU0sQ0FBQ0MsSUFBUCxDQUFZSixLQUFaLEVBQW1CTixNQUFsQzs7QUFFQXhCLFFBQUFBLENBQUMsQ0FBQ21DLE1BQUYsQ0FBU0wsS0FBVCxFQUFnQk0sSUFBaEIsQ0FBc0JDLElBQUQsSUFBVTtBQUM3QixjQUFJQSxJQUFJLENBQUNOLEtBQUwsS0FBZSxTQUFuQixFQUE4QjtBQUM1QixjQUFFQyxRQUFGO0FBQ0Q7QUFDRixTQUpEOztBQU1BLFlBQUlNLElBQUksR0FBR3RDLENBQUMsQ0FBQ21DLE1BQUYsQ0FBU0wsS0FBVCxFQUFnQk0sSUFBaEIsQ0FBc0JDLElBQUQsSUFBVTtBQUN0QyxpQkFBT0EsSUFBSSxDQUFDTixLQUFMLEtBQWUsUUFBdEI7QUFDSCxTQUZVLENBQVg7O0FBR0EsWUFBSU8sSUFBSSxJQUFJLElBQVosRUFBa0I7QUFDZCxpQkFBTyxZQUFQO0FBQ0g7O0FBRUQsWUFBSUMsTUFBTSxHQUFHdkMsQ0FBQyxDQUFDbUMsTUFBRixDQUFTTCxLQUFULEVBQWdCVSxNQUFoQixDQUF3QkgsSUFBRCxJQUFVO0FBQzFDLGlCQUFPQSxJQUFJLENBQUNOLEtBQUwsS0FBZSxRQUF0QjtBQUNILFNBRlksQ0FBYjs7QUFHQSxZQUFJUSxNQUFNLENBQUNmLE1BQVAsS0FBa0JRLFFBQWxCLElBQThCQSxRQUFRLEdBQUcsQ0FBN0MsRUFBZ0Q7QUFDNUMsaUJBQU8sWUFBUDtBQUNILFNBckJrRSxDQXVCbkU7OztBQUNBLFlBQUlTLE9BQU8sR0FBR3pDLENBQUMsQ0FBQ21DLE1BQUYsQ0FBU0wsS0FBVCxFQUFnQk0sSUFBaEIsQ0FBc0JDLElBQUQsSUFBVTtBQUN6QyxpQkFBT0EsSUFBSSxDQUFDTixLQUFMLEtBQWUsU0FBdEI7QUFDSCxTQUZhLENBQWQ7O0FBR0EsWUFBSVUsT0FBTyxJQUFJLElBQWYsRUFBcUI7QUFDakIsaUJBQU8sZUFBUDtBQUNIOztBQUVELGVBQU8sZUFBUDtBQUNILE9BaENEO0FBa0NBNUMsTUFBQUEsVUFBVSxDQUFDa0IsY0FBWCxDQUEwQixrQkFBMUIsRUFBOEMsVUFBVTJCLFFBQVYsRUFBb0J4QixNQUFwQixFQUE0QjtBQUN0RSxlQUFPaEIsTUFBTSxDQUFDd0MsUUFBUCxDQUFnQkEsUUFBaEIsRUFBMEIsY0FBMUIsRUFBMENDLE1BQTFDLENBQWlELGFBQWpELEVBQWdFO0FBQUNDLFVBQUFBLElBQUksRUFBRTtBQUFQLFNBQWhFLENBQVA7QUFDSCxPQUZEO0FBSUEvQyxNQUFBQSxVQUFVLENBQUNrQixjQUFYLENBQTBCLGlCQUExQixFQUE2QyxVQUFVOEIsU0FBVixFQUFxQjNCLE1BQXJCLEVBQTZCO0FBQ3RFLFlBQUllLE1BQU0sQ0FBQ0MsSUFBUCxDQUFZVyxTQUFaLEVBQXVCckIsTUFBdkIsR0FBZ0MsQ0FBcEMsRUFBdUM7QUFDbkMsaUJBQU9OLE1BQU0sQ0FBQ08sRUFBUCxDQUFVLElBQVYsQ0FBUDtBQUNIOztBQUNELGVBQU9QLE1BQU0sQ0FBQ1EsT0FBUCxDQUFlLElBQWYsQ0FBUDtBQUNILE9BTEQ7QUFRQTdCLE1BQUFBLFVBQVUsQ0FBQ2tCLGNBQVgsQ0FBMEIsZ0JBQTFCLEVBQTRDLFVBQVUrQixLQUFWLEVBQWlCNUIsTUFBakIsRUFBeUI7QUFDakUsWUFBSTRCLEtBQUssQ0FBQ2pCLElBQU4sQ0FBV2tCLFFBQVgsQ0FBb0IsT0FBcEIsQ0FBSixFQUFrQztBQUM5QixpQkFBTzdCLE1BQU0sQ0FBQ08sRUFBUCxDQUFVLElBQVYsQ0FBUDtBQUNIOztBQUNELGVBQU9QLE1BQU0sQ0FBQ1EsT0FBUCxDQUFlLElBQWYsQ0FBUDtBQUNILE9BTEQ7QUFPQTdCLE1BQUFBLFVBQVUsQ0FBQ2tCLGNBQVgsQ0FBMEIscUJBQTFCLEVBQWlELFVBQVUrQixLQUFWLEVBQWlCNUIsTUFBakIsRUFBeUI7QUFDdEUsWUFBSTRCLEtBQUssQ0FBQ2pCLElBQU4sS0FBZSxZQUFuQixFQUFpQztBQUM3QixpQkFBT1gsTUFBTSxDQUFDTyxFQUFQLENBQVUsSUFBVixDQUFQO0FBQ0g7O0FBQ0QsZUFBT1AsTUFBTSxDQUFDUSxPQUFQLENBQWUsSUFBZixDQUFQO0FBQ0gsT0FMRDtBQU9BN0IsTUFBQUEsVUFBVSxDQUFDa0IsY0FBWCxDQUEwQixxQkFBMUIsRUFBaUQsVUFBVStCLEtBQVYsRUFBaUI1QixNQUFqQixFQUF5QjtBQUN0RSxZQUFJNEIsS0FBSyxDQUFDakIsSUFBTixLQUFlLEtBQW5CLEVBQTBCO0FBQ3RCLGlCQUFPWCxNQUFNLENBQUNPLEVBQVAsQ0FBVSxJQUFWLENBQVA7QUFDSDs7QUFDRCxlQUFPUCxNQUFNLENBQUNRLE9BQVAsQ0FBZSxJQUFmLENBQVA7QUFDSCxPQUxEO0FBT0E3QixNQUFBQSxVQUFVLENBQUNrQixjQUFYLENBQTBCLGlCQUExQixFQUE2QyxVQUFVaUMsSUFBVixFQUFpQjlCLE1BQWpCLEVBQXlCO0FBQ2xFLGVBQU9WLGFBQWEsQ0FBQ3lDLGFBQXJCO0FBQ0gsT0FGRDtBQUlBcEQsTUFBQUEsVUFBVSxDQUFDa0IsY0FBWCxDQUEwQixVQUExQixFQUFzQyxVQUFVaUMsSUFBVixFQUFpQjlCLE1BQWpCLEVBQXlCO0FBQzNELFlBQUk4QixJQUFJLENBQUNELFFBQUwsQ0FBYyxnQkFBZCxDQUFKLEVBQXFDO0FBQ2pDLGlCQUFPLGdCQUFQO0FBQ0gsU0FGRCxNQUVPO0FBQ0gsaUJBQU8sWUFBUDtBQUNIO0FBQ0osT0FORDtBQU9BZCxNQUFBQSxNQUFNLENBQUNDLElBQVAsQ0FBWTFCLGFBQWEsQ0FBQzBDLGFBQTFCLEVBQXlDQyxPQUF6QyxDQUFrREMsR0FBRCxJQUFPO0FBQ3BEdkQsUUFBQUEsVUFBVSxDQUFDa0IsY0FBWCxDQUEwQnFDLEdBQTFCLEVBQStCNUMsYUFBYSxDQUFDMEMsYUFBZCxDQUE0QkUsR0FBNUIsQ0FBL0I7QUFDSCxPQUZEOztBQUlBLFVBQUlyRCxFQUFFLENBQUNzRCxjQUFILENBQWtCN0MsYUFBYSxDQUFDOEMsU0FBaEMsQ0FBSixFQUFnRDtBQUM3QyxZQUFJQyxRQUFRLEdBQUcvQyxhQUFhLENBQUNnRCxVQUFkLENBQXlCQyxPQUF6QixDQUFpQyxPQUFqQyxFQUEyQyxPQUEzQyxDQUFmO0FBQ0sxRCxRQUFBQSxFQUFFLENBQUMyRCxjQUFILENBQWtCSCxRQUFsQixFQUE0QkksSUFBSSxDQUFDQyxTQUFMLENBQWVwRCxhQUFhLENBQUNZLElBQTdCLENBQTVCO0FBQ1A7O0FBRUQsVUFBSXlDLFFBQVEsR0FBR2hFLFVBQVUsQ0FBQ2lFLE9BQVgsQ0FBbUJsRCxZQUFuQixDQUFmO0FBQ0EsVUFBSW1ELElBQUksR0FBR0YsUUFBUSxDQUFDckQsYUFBYSxDQUFDWSxJQUFmLENBQW5COztBQUVBLFVBQUlyQixFQUFFLENBQUNzRCxjQUFILENBQWtCN0MsYUFBYSxDQUFDOEMsU0FBaEMsQ0FBSixFQUFnRDtBQUM1Q3ZELFFBQUFBLEVBQUUsQ0FBQzJELGNBQUgsQ0FBa0JsRCxhQUFhLENBQUNnRCxVQUFoQyxFQUE0Q08sSUFBNUM7QUFDSDs7QUFDRCxVQUFJdkQsYUFBYSxDQUFDRSxHQUFsQixFQUF1QjtBQUNuQkYsUUFBQUEsYUFBYSxDQUFDRSxHQUFkLENBQWtCQyxLQUFsQixDQUF3QiwyQkFBeEI7QUFDSDs7QUFDREYsTUFBQUEsUUFBUSxDQUFDLElBQUQsQ0FBUjtBQUNILEtBMUpELENBMEpFLE9BQU11RCxFQUFOLEVBQVU7QUFDUixVQUFJeEQsYUFBYSxDQUFDRSxHQUFsQixFQUF1QjtBQUNuQkYsUUFBQUEsYUFBYSxDQUFDRSxHQUFkLENBQWtCdUQsS0FBbEIsQ0FBd0IsZ0RBQWdERCxFQUF4RTtBQUNIOztBQUNEdkQsTUFBQUEsUUFBUSxDQUFDLEtBQUQsQ0FBUjtBQUNIO0FBQ0o7O0FBbktnQjs7ZUFzS05ILGEiLCJzb3VyY2VzQ29udGVudCI6WyJcclxuY29uc3QgSGFuZGxlYmFycyA9IHJlcXVpcmUoJ2hhbmRsZWJhcnMnKTtcclxuY29uc3QgZnMgPSByZXF1aXJlKCdmcy1leHRyYScpO1xyXG5jb25zdCBfID0gcmVxdWlyZSgnbG9kYXNoJyk7XHJcbmNvbnN0IHBhdGggPSByZXF1aXJlKCdwYXRoJyk7XHJcbmNvbnN0IG1vbWVudCA9IHJlcXVpcmUoJ21vbWVudCcpO1xyXG5jb25zdCBiYXNlNjRJbWcgPSByZXF1aXJlKCdiYXNlNjQtaW1nJyk7XHJcbmNvbnN0IGxvZ2dlciA9IHJlcXVpcmUoJ0Bsb2c0anMtbm9kZS9sb2c0anMtYXBpJyk7XHJcblxyXG5jb25zdCBtb21lbnREdXJhdGlvbkZvcm1hdFNldHVwID0gcmVxdWlyZShcIm1vbWVudC1kdXJhdGlvbi1mb3JtYXRcIik7XHJcbm1vbWVudER1cmF0aW9uRm9ybWF0U2V0dXAobW9tZW50KTtcclxuXHJcbmNsYXNzIEh0bWxHZW5lcmF0b3IgIHtcclxuXHJcbiAgICBzdGF0aWMgaHRtbE91dHB1dChyZXBvcnRPcHRpb25zLCBjYWxsYmFjayA9ICgpID0+e30pIHtcclxuICAgICAgICB0cnkge1xyXG4gICAgICAgICAgICBpZiAocmVwb3J0T3B0aW9ucy5MT0cpIHtcclxuICAgICAgICAgICAgICAgIHJlcG9ydE9wdGlvbnMuTE9HLmRlYnVnKFwiSHRtbCBHZW5lcmF0aW9uIHN0YXJ0ZWRcIik7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgbGV0IHRlbXBsYXRlRmlsZSA9IGZzLnJlYWRGaWxlU3luYyhyZXBvcnRPcHRpb25zLnRlbXBsYXRlRmlsZW5hbWUsICd1dGY4Jyk7XHJcblxyXG4gICAgICAgICAgICBIYW5kbGViYXJzLnJlZ2lzdGVySGVscGVyKCdpbWFnZUFzQmFzZTY0JywgZnVuY3Rpb24gKHNjcmVlbnNob3RGaWxlLCBzY3JlZW5zaG90UGF0aCwgaGJvcHRzKSB7XHJcbiAgICAgICAgICAgICAgICAvLyBvY2N1cnMgd2hlbiB0aGVyZSBpcyBhbiBlcnJvciBmaWxlXHJcbiAgICAgICAgICAgICAgICBpZiAoIWZzLmV4aXN0c1N5bmMoc2NyZWVuc2hvdEZpbGUpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKHNjcmVlbnNob3RQYXRoKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHNjcmVlbnNob3RGaWxlID0gYCR7c2NyZWVuc2hvdFBhdGh9LyR7c2NyZWVuc2hvdEZpbGV9YFxyXG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHNjcmVlbnNob3RGaWxlID0gYCR7c2NyZWVuc2hvdEZpbGV9YFxyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIGNvbnN0IGRhdGEgPSBiYXNlNjRJbWcuYmFzZTY0U3luYyhwYXRoLnJlc29sdmUoYCR7c2NyZWVuc2hvdEZpbGV9YCkpO1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIGAke2RhdGF9YDtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIEhhbmRsZWJhcnMucmVnaXN0ZXJIZWxwZXIoJ2lzVmFsaWRSZXBvcnQnLCBmdW5jdGlvbiAoc3VpdGVzLCBoYm9wdHMpIHtcclxuICAgICAgICAgICAgICAgIGlmIChzdWl0ZXMgJiYgc3VpdGVzLmxlbmd0aCA+IDAgKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGhib3B0cy5mbih0aGlzKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIHJldHVybiBoYm9wdHMuaW52ZXJzZSh0aGlzKTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIEhhbmRsZWJhcnMucmVnaXN0ZXJIZWxwZXIoJ2lzVmFsaWRTdWl0ZScsIGZ1bmN0aW9uIChzdWl0ZSwgaGJvcHRzKSB7XHJcbiAgICAgICAgICAgICAgICBpZiAoc3VpdGUudGl0bGUubGVuZ3RoID4gMCAmJlxyXG4gICAgICAgICAgICAgICAgICAgIHN1aXRlLnR5cGUgPT09ICdzdWl0ZScgJiZcclxuICAgICAgICAgICAgICAgICAgICBzdWl0ZS50ZXN0cy5sZW5ndGggPiAwICkge1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBoYm9wdHMuZm4odGhpcyk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gaGJvcHRzLmludmVyc2UodGhpcyk7XHJcbiAgICAgICAgICAgIH0pO1xyXG5cclxuICAgICAgICAgICAgSGFuZGxlYmFycy5yZWdpc3RlckhlbHBlcigndGVzdFN0YXRlQ29sb3VyJywgZnVuY3Rpb24gKHN0YXRlLCBoYm9wdHMpIHtcclxuICAgICAgICAgICAgICAgIGlmIChzdGF0ZSA9PT0gJ3Bhc3NlZCcpIHtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gJ3Rlc3QtcGFzcyc7XHJcbiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHN0YXRlID09PSAnZmFpbGVkJykge1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiAndGVzdC1mYWlsJztcclxuICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoc3RhdGUgPT09ICdwZW5kaW5nJykge1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiAndGVzdC1wZW5kaW5nJztcclxuICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoc3RhdGUgPT09ICdza2lwcGVkJykge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuICd0ZXN0LXNraXBwZWQnO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0pO1xyXG5cclxuICAgICAgICAgICAgSGFuZGxlYmFycy5yZWdpc3RlckhlbHBlcigndGVzdFN0YXRlSWNvbicsIGZ1bmN0aW9uIChzdGF0ZSwgaGJvcHRzKSB7XHJcbiAgICAgICAgICAgICAgICBpZiAoc3RhdGUgPT09ICdwYXNzZWQnKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICc8c3BhbiBjbGFzcz1cInN1Y2Nlc3NcIj4mIzEwMDA0Ozwvc3Bhbj4nIDtcclxuICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoc3RhdGUgPT09ICdmYWlsZWQnKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICc8c3BhbiBjbGFzcz1cImVycm9yXCI+JiMxMDAwNjs8L3NwYW4+JyA7XHJcbiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHN0YXRlID09PSAncGVuZGluZycpIHtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gJzxzcGFuIGNsYXNzPVwicGVuZGluZ1wiPiYjMTAwMDQ7PC9zcGFuPicgO1xyXG4gICAgICAgICAgICAgICAgfSBlbHNlIGlmIChzdGF0ZSA9PT0gJ3NraXBwZWQnKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICc8c3BhbiBjbGFzcz1cInNraXBwZWRcIj4mIzEwMDM0Ozwvc3Bhbj4nIDtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSk7XHJcblxyXG4gICAgICAgICAgICBIYW5kbGViYXJzLnJlZ2lzdGVySGVscGVyKCdzdWl0ZVN0YXRlQ29sb3VyJywgZnVuY3Rpb24gKHRlc3RzLCBoYm9wdHMpIHtcclxuICAgICAgICAgICAgICAgIGxldCBudW1UZXN0cyA9IE9iamVjdC5rZXlzKHRlc3RzKS5sZW5ndGg7XHJcblxyXG4gICAgICAgICAgICAgICAgXy52YWx1ZXModGVzdHMpLmZpbmQoKHRlc3QpID0+IHtcclxuICAgICAgICAgICAgICAgICAgaWYgKHRlc3Quc3RhdGUgPT09IFwicGVuZGluZ1wiKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgLS1udW1UZXN0cztcclxuICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfSk7XHJcblxyXG4gICAgICAgICAgICAgICAgbGV0IGZhaWwgPSBfLnZhbHVlcyh0ZXN0cykuZmluZCgodGVzdCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB0ZXN0LnN0YXRlID09PSAnZmFpbGVkJztcclxuICAgICAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICAgICAgICBpZiAoZmFpbCAhPSBudWxsKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICdzdWl0ZS1mYWlsJztcclxuICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICBsZXQgcGFzc2VzID0gXy52YWx1ZXModGVzdHMpLmZpbHRlcigodGVzdCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB0ZXN0LnN0YXRlID09PSAncGFzc2VkJztcclxuICAgICAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICAgICAgICBpZiAocGFzc2VzLmxlbmd0aCA9PT0gbnVtVGVzdHMgJiYgbnVtVGVzdHMgPiAwKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICdzdWl0ZS1wYXNzJztcclxuICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICAvL3NraXBwZWQgaXMgdGhlIGxvd2VzdCBwcmlvcml0eSBjaGVja1xyXG4gICAgICAgICAgICAgICAgbGV0IHNraXBwZWQgPSBfLnZhbHVlcyh0ZXN0cykuZmluZCgodGVzdCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB0ZXN0LnN0YXRlID09PSAnc2tpcHBlZCc7XHJcbiAgICAgICAgICAgICAgICB9KVxyXG4gICAgICAgICAgICAgICAgaWYgKHNraXBwZWQgIT0gbnVsbCkge1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiAnc3VpdGUtcGVuZGluZyc7XHJcbiAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgcmV0dXJuICdzdWl0ZS11bmtub3duJ1xyXG4gICAgICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgICAgIEhhbmRsZWJhcnMucmVnaXN0ZXJIZWxwZXIoJ2h1bWFuaXplRHVyYXRpb24nLCBmdW5jdGlvbiAoZHVyYXRpb24sIGhib3B0cykge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIG1vbWVudC5kdXJhdGlvbihkdXJhdGlvbiwgXCJtaWxsaXNlY29uZHNcIikuZm9ybWF0KCdoaDptbTpzcy5TUycsIHt0cmltOiBmYWxzZX0pXHJcbiAgICAgICAgICAgIH0pO1xyXG5cclxuICAgICAgICAgICAgSGFuZGxlYmFycy5yZWdpc3RlckhlbHBlcignaWZTdWl0ZUhhc1Rlc3RzJywgZnVuY3Rpb24gKHRlc3RzSGFzaCwgaGJvcHRzKSB7XHJcbiAgICAgICAgICAgICAgICBpZiAoT2JqZWN0LmtleXModGVzdHNIYXNoKS5sZW5ndGggPiAwKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGhib3B0cy5mbih0aGlzKVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgcmV0dXJuIGhib3B0cy5pbnZlcnNlKHRoaXMpO1xyXG4gICAgICAgICAgICB9KTtcclxuXHJcblxyXG4gICAgICAgICAgICBIYW5kbGViYXJzLnJlZ2lzdGVySGVscGVyKCdpZkV2ZW50SXNFcnJvcicsIGZ1bmN0aW9uIChldmVudCwgaGJvcHRzKSB7XHJcbiAgICAgICAgICAgICAgICBpZiAoZXZlbnQudHlwZS5pbmNsdWRlcygnRXJyb3InKSkge1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBoYm9wdHMuZm4odGhpcyk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gaGJvcHRzLmludmVyc2UodGhpcyk7XHJcbiAgICAgICAgICAgIH0pO1xyXG5cclxuICAgICAgICAgICAgSGFuZGxlYmFycy5yZWdpc3RlckhlbHBlcignaWZFdmVudElzU2NyZWVuc2hvdCcsIGZ1bmN0aW9uIChldmVudCwgaGJvcHRzKSB7XHJcbiAgICAgICAgICAgICAgICBpZiAoZXZlbnQudHlwZSA9PT0gJ3NjcmVlbnNob3QnKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGhib3B0cy5mbih0aGlzKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIHJldHVybiBoYm9wdHMuaW52ZXJzZSh0aGlzKTtcclxuICAgICAgICAgICAgfSk7XHJcblxyXG4gICAgICAgICAgICBIYW5kbGViYXJzLnJlZ2lzdGVySGVscGVyKCdpZkV2ZW50SXNMb2dNZXNzYWdlJywgZnVuY3Rpb24gKGV2ZW50LCBoYm9wdHMpIHtcclxuICAgICAgICAgICAgICAgIGlmIChldmVudC50eXBlID09PSAnbG9nJykge1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBoYm9wdHMuZm4odGhpcyk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gaGJvcHRzLmludmVyc2UodGhpcyk7XHJcbiAgICAgICAgICAgIH0pO1xyXG5cclxuICAgICAgICAgICAgSGFuZGxlYmFycy5yZWdpc3RlckhlbHBlcignaWZDb2xsYXBzZVRlc3RzJywgZnVuY3Rpb24gKHRleHQgLCBoYm9wdHMpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiByZXBvcnRPcHRpb25zLmNvbGxhcHNlVGVzdHM7XHJcbiAgICAgICAgICAgIH0pO1xyXG5cclxuICAgICAgICAgICAgSGFuZGxlYmFycy5yZWdpc3RlckhlbHBlcignbG9nQ2xhc3MnLCBmdW5jdGlvbiAodGV4dCAsIGhib3B0cykge1xyXG4gICAgICAgICAgICAgICAgaWYgKHRleHQuaW5jbHVkZXMoJ1Rlc3QgSXRlcmF0aW9uJykpIHtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gXCJ0ZXN0LWl0ZXJhdGlvblwiO1xyXG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gXCJsb2ctb3V0cHV0XCI7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICBPYmplY3Qua2V5cyhyZXBvcnRPcHRpb25zLnRlbXBsYXRlRnVuY3MpLmZvckVhY2goKGtleSk9PntcclxuICAgICAgICAgICAgICAgIEhhbmRsZWJhcnMucmVnaXN0ZXJIZWxwZXIoa2V5LCByZXBvcnRPcHRpb25zLnRlbXBsYXRlRnVuY3Nba2V5XSk7XHJcbiAgICAgICAgICAgIH0pO1xyXG5cclxuICAgICAgICAgICAgaWYgKGZzLnBhdGhFeGlzdHNTeW5jKHJlcG9ydE9wdGlvbnMub3V0cHV0RGlyKSkge1xyXG4gICAgICAgICAgICAgICBsZXQganNvbkZpbGUgPSByZXBvcnRPcHRpb25zLnJlcG9ydEZpbGUucmVwbGFjZSgnLmh0bWwnICwgJy5qc29uJykgO1xyXG4gICAgICAgICAgICAgICAgICAgIGZzLm91dHB1dEZpbGVTeW5jKGpzb25GaWxlLCBKU09OLnN0cmluZ2lmeShyZXBvcnRPcHRpb25zLmRhdGEpKTtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgbGV0IHRlbXBsYXRlID0gSGFuZGxlYmFycy5jb21waWxlKHRlbXBsYXRlRmlsZSk7XHJcbiAgICAgICAgICAgIGxldCBodG1sID0gdGVtcGxhdGUocmVwb3J0T3B0aW9ucy5kYXRhKTtcclxuXHJcbiAgICAgICAgICAgIGlmIChmcy5wYXRoRXhpc3RzU3luYyhyZXBvcnRPcHRpb25zLm91dHB1dERpcikpIHtcclxuICAgICAgICAgICAgICAgIGZzLm91dHB1dEZpbGVTeW5jKHJlcG9ydE9wdGlvbnMucmVwb3J0RmlsZSwgaHRtbCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgaWYgKHJlcG9ydE9wdGlvbnMuTE9HKSB7XHJcbiAgICAgICAgICAgICAgICByZXBvcnRPcHRpb25zLkxPRy5kZWJ1ZyhcIkh0bWwgR2VuZXJhdGlvbiBjb21wbGV0ZWRcIik7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgY2FsbGJhY2sodHJ1ZSk7XHJcbiAgICAgICAgfSBjYXRjaChleCkge1xyXG4gICAgICAgICAgICBpZiAocmVwb3J0T3B0aW9ucy5MT0cpIHtcclxuICAgICAgICAgICAgICAgIHJlcG9ydE9wdGlvbnMuTE9HLmVycm9yKFwiSHRtbCBHZW5lcmF0aW9uIHByb2Nlc3NpbmcgZW5kZWQgaW4gZXJyb3I6IFwiICsgZXgpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGNhbGxiYWNrKGZhbHNlKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcbn1cclxuXHJcbmV4cG9ydCBkZWZhdWx0IEh0bWxHZW5lcmF0b3I7XHJcbiJdfQ==